<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Current Guidance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: sans-serif; 
      background: black; 
      color: white; 
      padding: 1rem; 
      margin: 0;
    }
    h2 { text-align: center; margin-bottom: 1rem; }
    pre { 
      white-space: pre-wrap; 
      font-size: 1rem; 
      background: rgba(255, 255, 255, 0.05); 
      padding: 10px; 
      border-radius: 6px; 
    }
    button {
      display: block;
      margin: 10px auto;
      padding: 10px 16px;
      font-size: 1rem;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background-color: gold;
      color: black;
    }
  </style>
</head>
<body>

<h2>Current Guidance</h2>
<pre id="guidanceText">Loading...</pre>
<button id="updateLocationBtn">Update Location</button>

<script src="ephemeris.js"></script>
<script src="zodiac.js"></script>
<script src="planetary.js"></script>
<script src="dignity.js"></script>
<script src="storage.js"></script>
<script src="guidance.js"></script>

<script>
async function loadGuidance() {
  const container = document.getElementById("guidanceText");
  container.innerText = "Loading...";

  const location = loadLocation();
  if (!location) {
    container.innerText = "No location set. Click 'Update Location' above.";
    return;
  }

  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const dayRuler = DAY_RULERS[today.getDay()] || "Sun";

  let sunTimes;
  try {
    sunTimes = getSunTimes(today, location.lat, location.lon);
  } catch (err) {
    console.error("Error computing sun times:", err);
    container.innerText = "Error computing sunrise/sunset for your location.";
    return;
  }

  const hours = generatePlanetaryHours(dayRuler, sunTimes.sunrise, sunTimes.sunset);
  const currentHour = getCurrentPlanetaryHour(hours, now);

  if (!currentHour) {
    container.innerText = "No active planetary hour right now.";
    return;
  }

  // Zodiac
  const zodiac = getPlanetZodiac(currentHour.planet.name, now);

  // Natal resonance
  let natalMatch = false;
  const natalRaw = localStorage.getItem("birthData");
  if (natalRaw) {
    try {
      const natal = JSON.parse(natalRaw);
      if (natal.date && natal.time) {
        const natalDate = new Date(`${natal.date}T${natal.time}`);
        const natalLongs = planetLongitudes(natalDate);
        const natalZodiac = getZodiacFromLongitude(natalLongs[currentHour.planet.name]);
        natalMatch = natalZodiac.name === zodiac.name;
      }
    } catch (err) { console.warn("Invalid natal data", err); }
  }

  // Dignity & strength
  const dignity = getDignity(currentHour.planet.name, zodiac.name);
  const strength = getHourStrength(currentHour.planet.name, zodiac.name, natalMatch);

  // Planetary seal (optional)
  const seal = (typeof PLANET_SEALS !== "undefined" && PLANET_SEALS[currentHour.planet.name])
    ? PLANET_SEALS[currentHour.planet.name]
    : "N/A";

  // Guidance text
  const guidanceText = (typeof generateGuidance === "function")
    ? generateGuidance(currentHour.planet.name, zodiac.name, natalMatch)
    : "No guidance text defined.";

  container.innerText =
    `Planetary Seal: ${seal}\n` +
    `Planet: ${currentHour.planet.symbol} ${currentHour.planet.name}\n` +
    `Zodiac: ${zodiac.symbol} ${zodiac.name}\n` +
    `Dignity: ${dignity}\n` +
    `Strength Score: ${strength}\n` +
    `${natalMatch ? "Resonant with natal chart\n" : ""}\n` +
    guidanceText;
}

// Update location
document.getElementById("updateLocationBtn").addEventListener("click", async () => {
  const input = prompt("Enter your city, state, and country (USA assumed if missing country):");
  if (!input) return;

  const safeInput = input.trim() + (input.split(",").length === 2 ? ", USA" : "");

  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(safeInput)}`,
      { headers: { "User-Agent": "PlanetaryHoursApp/1.0", "Accept": "application/json" } }
    );
    const data = await response.json();
    if (!data || data.length === 0) { alert("Location not found."); return; }

    saveLocation(parseFloat(data[0].lat), parseFloat(data[0].lon), input);
    loadGuidance();
  } catch (err) {
    console.error("Location fetch failed:", err);
    alert("Error retrieving location. Check your internet connection.");
  }
});

// Initial load
loadGuidance();

// Refresh guidance every 5 minutes
setInterval(loadGuidance, 5 * 60 * 1000);
</script>

</body>
</html>
